# Web AR Drum Training System

このプロジェクトは、ARマーカーを用いてドラムパーツに演奏ガイドを表示し、リズム練習を行えるWebアプリケーションです。

旧版を "A Web AR Application to Practice Drums" として NBiS 2024 にて発表。  
当システムは、コードを全て刷新し、新機能と新UIを織り込んだものとなります。

---

## 旧版からの変更・追加点

### AR機能の一部使用
旧版では全ての機能を１画面で行っていたこともあり、常にARに関する機能が回りっぱなしであった。処理を軽くし発音のレイテンシを緩和するため、ARの機能はマーカの座標取得のみに絞り、以降`Canvas`を用いた描画ループで演奏ガイドを表示する。

### ページ遷移
上記から、`AR.js`内蔵のカメラから`<Video>`を用いたカメラに変更する必要があるため、2つのページを遷移するようにした。

### 楽譜ファイルとBPM
演奏時にガイドを表示するための、どのドラムパーツかを示すMIDI番号と叩くべき時刻（＝ガイドが表示される時刻）からなる`txt`の楽譜ファイルを、ユーザがファイルから選択して読み込む必要があったが、`JSON形式`に変更しシステム内に埋め込んだ。  
また、ユーザがBPM（テンポ）を設定できるようにしたため、時刻をステップに変更した。BPMから一拍ごとの間隔時間を算出し、ステップに乗算することで、リアルタイムで時刻を変更し格納する。

### メトロノーム音声の追加
旧版ではリズム練習と銘打っておいてメトロノームもBGMも実装されていなかった。当システムではBPMに合わせて、演奏時にメトロノームが発声されるようにした。

### 評価方法の変更
旧版では正しくドラムを叩けると、「good」「exellent（原文ママ）」と演奏ガイド付近に表示されていたが、ドラムのようなターゲットが複数あり、叩く間隔が短い場合もある楽器においては煩雑であったため、直感的に評価がわかるフラッシュ風エフェクトに変更した。

### システム内時刻の共有
当システムでは時刻を取り扱う機能が多いため、`AudioContext.currentTime`を共通して用いることにした。  
これは`WebAudioAPI`における音源の発声、とりわけシーケンサーのような発声間隔が常に一定でなくてはならないような機能における音源発声の一括予約をする場面に強い、正確な時刻である。特にメトロノーム発声はシーケンサーと同様の仕様であり、ユーザにとってメトロノームの正確性は最重要であるため採用した。

### ドラム音源の加工
`WebAudioAPI`を用いてドラム音源の、ボリューム・パン・リバーブをそれぞれ調整できるようにした。

---

## 機能概要

### 1. ARマーカ座標取得ページ (`/ar`)
- システムは`AR.js`内蔵のカメラ映像を左右反転で表示する。
- ユーザはカメラを利用し、Kick / Snare / Hi-hat に対応するマーカーを欠けがないように映す。
- システムは`AR.js`を用いてマーカーの3D座標を取得し、`localStorage` に保存する。
- システムは`A-Frame`を用いて各マーカー位置に薄いリング（ターゲットリング）を常時表示する。ユーザによる認識ボタン押下で座標が固定される。

### 2. 演奏ページ (`/canvas`)
- 当ページではARの各種機能は用いず、`<Video>（getUserMedia()）`によるカメラ映像の出力、そこにCanvasによるリング表示を重ね合わせている。
- システムはカメラ映像を左右反転で表示する。
- システムは`localStorage` に保存されたマーカー座標を2D座標へ変換してリングを表示する。
- システムはJSON形式の譜面ファイルを読み込み、現在のBPMに合わせガイドの出現時刻を計算し記憶しておく。
- ユーザはBPMをスライダーで設定でき、システムはそれに応じた出現時刻を更新する。
- 演奏開始ボタン押下:
  - メトロノーム音源を発声（1拍目は強拍音）。
  - 譜面のMIDI番号と時刻を元に、番号に対応した位置と時刻で収縮するリング（インストラクションリング）を表示する。
  - ユーザがMIDIデバイスを叩くと、正しいドラムパーツを叩けたか、正しい時刻で叩けたか（PERFECT / GOOD の2種）の判定がが行われる。
  - 判定成功時、固定リングがフラッシュしてユーザへフィードバックを促す。

### 3. サイドバー
- `WebAudioAPI`による各ドラム音源の音量・パン・リバーブを別個調整可能。
- ハイハットには Open / Foot / Close などバリエーションがあり、同時発音しないよう制御する。かつ調整は一つに統合されている。

---

## ディレクトリ構成
```
project-root/
├── ar/                # ARマーカ取得ページ
│   ├── index.html
│   ├── script.js
│   └── style.css
├── canvas/            # 演奏ページ
│   ├── index.html
│   ├── script.js
│   └── style.css
├── shared/            # サイドバー等の共通コンポーネント
│   ├── sidebar.html
│   ├── sidebar.js
│   └── sidebar.css
├── inst/              # 使用する音源ファイル
│   ├── kick.mp3
│   ├── snare.mp3
│   ├── hihatClosed.mp3
│   ├── hihatOpen.mp3
│   ├── hihatFoot.mp3
│   ├── count.mp3
│   └── countHead.mp3
├── markers/           # AR.js 用のマーカパターン
│   ├── kick.patt
│   ├── snare.patt
│   └── hihat.patt
└── assets/          # 譜面データ（JSON形式）
    ├── pattern1.json
    ├── pattern2.json
    └── pattern3.json
```

---

## 譜面ファイル仕様（例：pattern1.json）

```json
{
  "subdivision": 4,         // 1拍を分割する数（例: 4 = 16分音符単位）
  "pattern": [
    { "step": 17,  "note": 36 }, // Kick
    { "step": 21,  "note": 38 }, // Snare
    { "step": 25,  "note": 36 }, // Kick
    { "step": 29, "note": 38 }  // Snare
  ]
}
```
> [!TIP]
> 演奏開始時、カウントインとなる時間を考慮し、stepは17から開始することを推奨する（17からだとカウント4回分）。

---

## 参考

このプロジェクトの設計・実装は以下の論文に基づく。
- Asahi Onuki, "A Web AR Application to Practice Drums", NBiS, 2024  
- Kaito Kikuchi, "An AR System to Practice Drums", NBiS, 2021
